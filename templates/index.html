<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <title>Web Scraping</title>
</head>

<body>
    <p> Select appliance type: </p>
    <select id="appliancetype">
        <option value="Refrigerators">Refrigerators</option>
        <option value="Room AC">Room AC</option>
        <option value="Central AC">Central AC</option>
        <option value="Portable AC">Portable AC</option>
        <option value="Vented Gas&Oil Heaters">Vented Gas&Oil Heaters</option>
        <option value="Water Heaters">Water Heaters</option>
        <option value="Pool Heaters">Pool Heaters</option>
        <option value="Plumbing Fittings">Plumbing Fittings</option>
        <option value="Plumbing Fixtures">Plumbing Fixtures</option>
        <option value="Fluorescent Lamp Ballasts">Fluorescent Lamp Ballasts</option>
        <option value="Lamps">Lamps</option>
        <option value="Emergency Lighthing">Emergency Lighthing</option>
        <option value="Traffic Signal Moudles">Traffic Signal Moudles</option>
        <option value="Luminaires">Luminaires</option>
        <option value="Dishwashers">Dishwashers</option>
        <option value="Clothes Washers">Clothes Washers</option>
        <option value="Clothes Dryers">Clothes Dryers</option>
        <option value="Cooking Products">Cooking Products</option>
        <option value="Electric Motors&Compressors">Electric Motors&Compressors</option>
        <option value="Distribution Transformers">Distribution Transformers</option>
        <option value="External Power Supplies">External Power Supplies</option>
        <option value="Computers">Computers</option>
        <option value="Battery Charger Systems">Battery Charger Systems</option>
        <option value="Landscape Irrigation Eqmt">Landscape Irrigation Eqmt</option>
        <option value="Other">Other</option>
    </select>
    <p> Enter File Name (default name: amazon_data.csv): </p>
    <input type="text" id="filenamebox" placeholder="amazon_data.csv">
    <p> Enter URL: </p>
    <input type="text" id="urlbox" placeholder="Enter URL">
    <br> <br>
    <button onclick="clickedSumbitButton()">Submit</button>
    <br>
    <button onclick="clickedDownloadButton()">Download</button>
    <br>
    <progress id="progressbar" value="0" max="100"></progress>
    <br>
    <p id="helpmessage">Enter the required fields, and then click submit!</p>

    <script>
        let has_headers = 0;
        let isDone = false;
        let isValid = true;
        let count_products = 4
        let allData = "";
        let filename = document.getElementById("filenamebox");
        if (filename.value === undefined || filename.value === "") {
            filename.value = "amazon_data.csv";
        }
        const progress = document.getElementById("progressbar");
        const helpMessage = document.getElementById("helpmessage");
        timeoutID = 0;
        function clickedSumbitButton() {
            isValid = true;
            progress.value = 0;
            clearTimeout(timeoutID);
            isDone = false;
            let selectedAppliance = document.getElementById("appliancetype").value;

            helpMessage.textContent = "Running... Please wait until we finish processing this URL before continuing";
            const URLbox = document.getElementById("urlbox");
            moveProgressBar();
            fetch(`/call_function?appliance=${selectedAppliance}&filename=${filename}&url=${URLbox.value}&countproducts=${count_products}&has_headers=${has_headers}`)
                .then(response => response.json())
                .then(data => {
                    const filevalues = data[0];
                    const count = data[1];
                    URLbox.value = "";
                    if (count == "URLError" || filevalues == "not valid") {
                        helpMessage.textContent = "Invalid URL. Please enter another URL and make sure it starts with https://";
                        isValid = false;
                        progress.value = 0;
                    } if (isValid) {
                        helpMessage.textContent = "Finished running. Please enter another URL or quit"
                        count_products = parseInt(count);
                        isDone = true;
                        allData += "\n" + filevalues;
                        if (has_headers == 0) { has_headers = 1; }
                    }
                });
        }

        function clickedDownloadButton() {
            // download file
            const file = new Blob([allData], { type: 'text/csv' });
            const fileinfo = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = fileinfo;
            a.download = filename.value;
            a.click();
            URL.revokeObjectURL(fileinfo);
        }

        function moveProgressBar() {
            let progressMax = parseInt(progress.max);
            let progressValue = parseInt(progress.value);
            if (isValid) {
                if (!isDone) {
                    if (progressValue < progressMax) {
                        progress.value += 10;
                    } else {
                        progress.value = 0;
                    }
                }
                else {
                    progress.value = progressMax;
                }
            }
            timeoutID = setTimeout(moveProgressBar, 1000);
        }



    </script>
</body>


</html>